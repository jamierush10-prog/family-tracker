<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paycheck 2 Paycheck</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg-color: #0f172a; --card-bg: #1e293b; --input-bg: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --accent-green: #10b981; --accent-red: #ef4444; 
            --accent-blue: #3b82f6; --accent-orange: #f59e0b; 
            --accent-yellow: #facc15; 
            --border-color: #334155;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .dashboard { width: 100%; max-width: 650px; display: none; }
        
        /* HEADER & STATUS */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom:15px; border-bottom:1px solid var(--border-color); }
        .app-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); letter-spacing: 1px; }
        .status-badge { font-size: 0.7rem; background: #334155; padding: 4px 8px; border-radius: 4px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; display: inline-block; }
        .btn-signout { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; transition: all 0.2s; }
        .btn-signout:active { background: var(--input-bg); color: white; }

        /* Summary Card */
        .summary-card { background-color: var(--card-bg); padding: 30px 25px; border-radius: 16px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); }
        .summary-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: 600; letter-spacing: 1px;}
        .summary-balance { font-size: 4rem; font-weight: 700; margin: 10px 0; letter-spacing: -2px; color: var(--text-main); transition: color 0.3s ease; }
        .flow-container { display: flex; justify-content: center; gap: 40px; margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .flow-item div:first-child { font-size: 0.75rem; color: var(--text-muted); margin-bottom:5px; text-transform: uppercase;}
        .flow-item div:last-child { font-size: 1.1rem; font-weight: 600; }
        .text-green { color: var(--accent-green); } .text-red { color: var(--accent-red); } .text-yellow { color: var(--accent-yellow); }
        .reset-date { font-size: 0.7rem; color: #64748b; margin-top: 6px; font-weight: 500; letter-spacing: 0.5px; }

        /* DAILY TRACKER */
        .daily-wrapper { overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .daily-row { display: flex; gap: 10px; min-width: max-content; }
        .daily-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 15px; text-align: center; min-width: 75px; display: flex; flex-direction: column; gap: 4px; }
        .day-name { font-weight: 700; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; }
        .day-target { font-size: 0.75rem; color: var(--text-muted); opacity: 0.8; }
        .day-actual { font-weight: 600; font-size: 0.9rem; }
        
        /* ACTION BUTTONS */
        .admin-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .btn-big { padding: 15px; border-radius: 12px; font-weight: 600; cursor: pointer; text-align: center; font-size: 0.95rem; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-add { background: var(--accent-blue); color: white; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .btn-reset { background: rgba(245, 158, 11, 0.15); border: 1px solid var(--accent-orange); color: var(--accent-orange); }

        /* LOGS */
        .section-header { font-weight: 600; font-size: 1.1rem; margin-bottom: 10px; }
        .log-list { list-style: none; padding: 0; margin: 0; padding-bottom: 50px; }
        .log-item { background-color: var(--card-bg); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
        .log-item:active { background-color: #263345; }
        .log-left { display: flex; flex-direction: column; gap: 4px; }
        .log-payee { font-weight: 500; font-size: 1rem; }
        .log-meta { font-size: 0.8rem; color: var(--text-muted); }
        .log-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .log-amount { font-weight: 600; font-size: 1rem; }
        .log-pct { font-size: 0.75rem; color: #64748b; margin-top: 2px; font-weight: 500; }

        /* FAMILY MODE HIDING */
        body.family-mode .admin-controls { display: none !important; }
        body.family-mode .log-list { display: block !important; } 
        body.family-mode .log-item { pointer-events: none; } 
        body.family-mode .fab { display: none !important; } 
        body.family-mode .log-hint { display: none !important; }

        /* LOCK SCREEN */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--text-muted); transition: background 0.2s; }
        .dot.filled { background: var(--accent-blue); border-color: var(--accent-blue); }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 300px; width: 100%; }
        .key { width: 70px; height: 70px; border-radius: 50%; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border-color); margin: 0 auto; user-select: none; }
        .key:active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .key-del { background: transparent; border: none; font-size: 1rem; color: var(--text-muted); }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 100; }
        .modal-card { background: var(--card-bg); width: 90%; max-width: 450px; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
        input, select { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color); color: white; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        .btn-primary { background: var(--text-main); color: var(--bg-color); width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-delete { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); border: 1px solid var(--accent-red); width: 100%; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; display: none; }
        .btn-text { background: none; border: none; color: var(--text-muted); cursor: pointer; width: 100%; margin-top: 15px; }
        
        .fab { position: fixed; bottom: 40px; right: 20px; background-color: var(--accent-blue); color: white; width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 32px; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); display: flex; align-items: center; justify-content: center; z-index: 90; }
    </style>
</head>
<body>

<div id="lockScreen">
    <div style="margin-bottom:30px; font-weight:600; letter-spacing:2px; font-size:0.9rem; color:#888;">ENTER PIN</div>
    <div class="pin-dots">
        <div class="dot" id="dot1"></div>
        <div class="dot" id="dot2"></div>
        <div class="dot" id="dot3"></div>
        <div class="dot" id="dot4"></div>
    </div>
    <div class="keypad">
        <div class="key" onclick="pressKey(1)">1</div>
        <div class="key" onclick="pressKey(2)">2</div>
        <div class="key" onclick="pressKey(3)">3</div>
        <div class="key" onclick="pressKey(4)">4</div>
        <div class="key" onclick="pressKey(5)">5</div>
        <div class="key" onclick="pressKey(6)">6</div>
        <div class="key" onclick="pressKey(7)">7</div>
        <div class="key" onclick="pressKey(8)">8</div>
        <div class="key" onclick="pressKey(9)">9</div>
        <div class="key key-del"></div>
        <div class="key" onclick="pressKey(0)">0</div>
        <div class="key key-del" onclick="clearPin()">⌫</div>
    </div>
</div>

<div class="dashboard" id="mainDashboard">
    <div class="app-header">
        <div>
            <div class="app-title">Paycheck 2 Paycheck</div>
            <div class="status-badge" id="modeBadge">Loading...</div>
        </div>
        <button class="btn-signout" onclick="signOut()">Sign Out</button>
    </div>

    <div class="summary-card">
        <div class="summary-label">Available Funds</div>
        <div class="summary-balance" id="displayBalance">...</div>
        <div class="flow-container">
            <div class="flow-item">
                <div>Weekly Funding</div>
                <div class="text-green" id="displayIncome">...</div>
                <div id="displayNextReset" class="reset-date"></div>
            </div>
            <div class="flow-item">
                <div>Expenses (Out)</div>
                <div class="text-red" id="displayExpense">...</div>
            </div>
        </div>
    </div>

    <div style="font-weight:600; font-size:0.9rem; margin-bottom:10px;">Daily Pacing</div>
    <div class="daily-wrapper">
        <div class="daily-row" id="dailyRow">
            </div>
    </div>

    <div class="admin-controls">
        <button class="btn-big btn-add" onclick="openMainModal()">+ New Transaction</button>
        <button class="btn-big btn-reset" onclick="resetWeek()">Weekly Reset ↺</button>
    </div>

    <div class="section-header">Transaction Log</div>
    <div class="log-hint" style="font-size:0.8rem; color:#666; margin-bottom:10px; font-style:italic;">Tap to edit</div>
    <ul class="log-list" id="transactionList"></ul>
</div>

<button class="fab" id="fabAdd" onclick="openMainModal()">+</button>

<div class="modal-overlay" id="mainModal">
    <div class="modal-card">
        <h2 style="margin-top:0; font-size:1.2rem;" id="modalTitle">New Transaction</h2>
        <div class="form-row">
            <div><label class="form-label">Type</label><select id="inputType"><option value="expense">Expense (Out)</option><option value="income">Income (In)</option></select></div>
            <div><label class="form-label">Date</label><input type="date" id="inputDate"></div>
        </div>
        <div class="form-group"><label class="form-label">Amount</label><input type="number" id="inputAmount" placeholder="0.00" step="0.01"></div>
        <div class="form-group"><label class="form-label">Payee</label><input type="text" id="inputPayee" placeholder="e.g. Costco"></div>
        <div class="form-group"><label class="form-label">For (Memo)</label><input type="text" id="inputPurpose" placeholder="e.g. Weekly Groceries"></div>
        
        <button id="btnSave" class="btn-primary" onclick="saveTransaction()">Save Record</button>
        <button id="btnDelete" class="btn-delete" onclick="deleteTransaction()">Delete Record</button>
        <button class="btn-text" onclick="closeMainModal()">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBLFyr142xhL8OZroHAnsGGSWX7hPf1UG0",
        authDomain: "family-wealth-tracker-18699.firebaseapp.com",
        projectId: "family-wealth-tracker-18699",
        storageBucket: "family-wealth-tracker-18699.firebasestorage.app",
        messagingSenderId: "162214392302",
        appId: "1:162214392302:web:3e40142cbed3df59fbdeff"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let localState = { transactions: [] };
    let editingId = null; 

    // --- LOCK SCREEN LOGIC ---
    const MASTER_PIN = "0703"; 
    const FAMILY_PIN = "1112";
    let enteredPin = "";

    window.pressKey = function(num) {
        if(enteredPin.length < 4) {
            enteredPin += num;
            updateDots();
            if(enteredPin.length === 4) checkPin();
        }
    }

    window.clearPin = function() {
        enteredPin = enteredPin.slice(0, -1);
        updateDots();
    }

    function updateDots() {
        for(let i=1; i<=4; i++) {
            const dot = document.getElementById(`dot${i}`);
            if(i <= enteredPin.length) dot.classList.add('filled');
            else dot.classList.remove('filled');
        }
    }

    function checkPin() {
        if(enteredPin === MASTER_PIN) {
            localStorage.setItem('authLevel', 'master');
            unlockApp('master');
        } else if (enteredPin === FAMILY_PIN) {
            localStorage.setItem('authLevel', 'family');
            unlockApp('family');
        } else {
            setTimeout(() => {
                enteredPin = "";
                updateDots();
                alert("Incorrect Passcode");
            }, 200);
        }
    }

    function unlockApp(level) {
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('mainDashboard').style.display = 'block';
        if (level === 'family') {
            document.body.classList.add('family-mode');
            document.getElementById('modeBadge').innerText = "Family View";
        } else {
            document.body.classList.remove('family-mode');
            document.getElementById('modeBadge').innerText = "Admin Mode";
        }
    }

    window.signOut = function() {
        localStorage.removeItem('authLevel');
        enteredPin = "";
        updateDots();
        document.getElementById('mainDashboard').style.display = 'none';
        document.getElementById('lockScreen').style.display = 'flex';
    }

    function checkAuth() {
        const level = localStorage.getItem('authLevel');
        if(level) {
            unlockApp(level);
        }
    }

    // --- LISTENERS ---
    onSnapshot(query(collection(db, "transactions"), orderBy("date", "desc")), (snap) => {
        localState.transactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
    });

    // --- RENDER MASTER ---
    window.render = function() {
        // Sort
        localState.transactions.sort((a, b) => {
            if (a.date !== b.date) return new Date(b.date) - new Date(a.date);
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        });

        let income = 0; 
        let expense = 0;
        
        // Find Funding Row
        const fundingTx = localState.transactions.find(t => t.purpose === "Reset");
        const totalFunding = fundingTx ? fundingTx.amount : 0;

        // CALCULATE NEXT RESET DATE
        const resetEl = document.getElementById('displayNextReset');
        if (fundingTx) {
            const parts = fundingTx.date.split('-'); 
            const localDate = new Date(parts[0], parts[1]-1, parts[2]); 
            localDate.setDate(localDate.getDate() + 7); 
            resetEl.innerText = `Next: ${localDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}`;
        } else {
            resetEl.innerText = "";
        }

        // GENERATE DAILY PACING ROW & COLOR LOGIC
        const dailyRow = document.getElementById('dailyRow');
        dailyRow.innerHTML = '';
        
        let accumulatedTarget = 0;
        let accumulatedSpend = 0;
        
        // Accurate Local Date for Comparison
        const now = new Date();
        const nowStr = getLocalDate(); // YYYY-MM-DD

        if(fundingTx) {
            const parts = fundingTx.date.split('-');
            const startDate = new Date(parts[0], parts[1]-1, parts[2]);
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const pctMap = { 'Mon': 0.1, 'Tue': 0.1, 'Wed': 0.1, 'Thu': 0.1, 'Fri': 0.1, 'Sat': 0.3, 'Sun': 0.2 };

            for(let i=0; i<7; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                
                const isoDate = d.toISOString().slice(0,10);
                const dayName = dayNames[d.getDay()];
                const dayTarget = totalFunding * pctMap[dayName];
                
                // Calc Actual Spend for this day
                let daySpend = 0;
                localState.transactions.forEach(t => {
                    if(t.type === 'expense' && t.date === isoDate) daySpend += t.amount;
                });

                // Cumulative tracking for Main Balance color
                if (isoDate <= nowStr) {
                    accumulatedTarget += dayTarget;
                    accumulatedSpend += daySpend;
                }

                // Color Logic (ISOLATED DAY LOGIC)
                const isFuture = isoDate > nowStr;
                let actualClass = 'text-green';
                let valueText = formatMoneyNoDec(daySpend);
                
                if (isFuture) {
                    actualClass = 'text-muted'; 
                } else {
                    // Simple Check: Did I spend more than TODAY's target?
                    if (daySpend > dayTarget) actualClass = 'text-red';
                }

                dailyRow.innerHTML += `
                    <div class="daily-card">
                        <div class="day-name">${dayName}</div>
                        <div class="day-target">Goal: ${formatMoneyNoDec(dayTarget)}</div>
                        <div class="day-actual ${actualClass}">${valueText}</div>
                    </div>
                `;
            }
        }

        // MAIN TOTALS & COLORS
        localState.transactions.forEach(t => {
            if (t.type === 'income') income += t.amount;
            if (t.type === 'expense') expense += t.amount;
        });

        const currentBalance = income - expense;
        const balanceEl = document.getElementById('displayBalance');
        balanceEl.textContent = formatMoney(currentBalance);
        
        balanceEl.className = 'summary-balance';
        if (currentBalance < 0) {
            balanceEl.classList.add('text-red');
        } else if (accumulatedSpend > accumulatedTarget) {
            balanceEl.classList.add('text-yellow');
        }

        document.getElementById('displayIncome').textContent = '+' + formatMoney(income);
        document.getElementById('displayExpense').textContent = '-' + formatMoney(expense);

        // LOGS
        const logList = document.getElementById('transactionList');
        logList.innerHTML = '';
        
        if(localState.transactions.length === 0) {
            logList.innerHTML = '<li style="text-align:center; padding:20px; color:#555;">No transactions this period. Start by resetting the week!</li>';
        }

        const isMaster = localStorage.getItem('authLevel') === 'master';

        localState.transactions.forEach(t => {
            let colorClass = 'text-main'; let sign = '';
            if(t.type === 'income') { colorClass = 'text-green'; sign = '+'; }
            if(t.type === 'expense') { colorClass = 'text-red'; sign = '-'; }
            
            let metaString = t.purpose || "";
            
            let percentHtml = "";
            if (totalFunding > 0 && t.type === 'expense' && t.id !== fundingTx?.id) {
                const pct = (t.amount / totalFunding) * 100;
                if (pct > 0.1) percentHtml = `<div class="log-pct">${pct.toFixed(1)}%</div>`;
            }

            const clickAttr = isMaster ? `onclick="editTransaction('${t.id}')"` : "";
            const cursorClass = isMaster ? "clickable" : "";

            logList.innerHTML += `
                <li class="log-item ${cursorClass}" ${clickAttr}>
                    <div class="log-left"><div class="log-payee">${t.payee}</div><div class="log-meta"><span>${t.date}</span> &bull; ${metaString}</div></div>
                    <div class="log-right">
                        <div class="log-amount ${colorClass}">${sign}${formatMoney(t.amount)}</div>
                        ${percentHtml}
                    </div>
                </li>`;
        });
    }

    // --- LOGIC ---
    window.resetWeek = async function() {
        if (localStorage.getItem('authLevel') !== 'master') return;

        const amountStr = prompt("Start New Week: How much funding?");
        const amount = parseFloat(amountStr);
        if (!amount || isNaN(amount)) return;

        if(confirm(`This will DELETE all current transactions and start a new week with $${amount}. Confirm?`)) {
            try {
                const batch = writeBatch(db);
                localState.transactions.forEach(t => {
                    const docRef = doc(db, "transactions", t.id);
                    batch.delete(docRef);
                });
                await batch.commit();

                await addDoc(collection(db, "transactions"), {
                    date: getLocalDate(),
                    payee: "Weekly Funding",
                    purpose: "Reset",
                    amount: amount,
                    type: 'income',
                    createdAt: new Date().toISOString()
                });
            } catch(e) { alert("Error resetting: " + e.message); }
        }
    }

    window.getLocalDate = function() {
        const d = new Date(); d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0,10);
    }

    window.formatMoney = function(num) { return '$' + num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
    window.formatMoneyNoDec = function(num) { return '$' + Math.round(num).toLocaleString('en-US'); }
    window.closeMainModal = function() { document.getElementById('mainModal').style.display = 'none'; }

    window.openMainModal = function() {
        editingId = null;
        document.getElementById('modalTitle').innerText = "New Transaction";
        document.getElementById('btnSave').innerText = "Save Record";
        document.getElementById('btnDelete').style.display = 'none';
        
        document.getElementById('inputType').value = 'expense';
        document.getElementById('inputDate').value = getLocalDate();
        document.getElementById('inputAmount').value = '';
        document.getElementById('inputPayee').value = '';
        document.getElementById('inputPurpose').value = '';
        document.getElementById('mainModal').style.display = 'flex';
    }

    window.editTransaction = function(id) {
        const t = localState.transactions.find(x => x.id === id);
        if(!t) return;

        editingId = t.id;
        document.getElementById('modalTitle').innerText = "Edit Transaction";
        document.getElementById('btnSave').innerText = "Update Transaction";
        document.getElementById('btnDelete').style.display = 'block';

        document.getElementById('inputType').value = t.type;
        document.getElementById('inputDate').value = t.date;
        document.getElementById('inputAmount').value = t.amount;
        document.getElementById('inputPayee').value = t.payee;
        document.getElementById('inputPurpose').value = t.purpose || '';
        document.getElementById('mainModal').style.display = 'flex';
    }

    window.saveTransaction = async function() {
        const type = document.getElementById('inputType').value;
        const date = document.getElementById('inputDate').value;
        const amount = parseFloat(document.getElementById('inputAmount').value);
        const payee = document.getElementById('inputPayee').value;
        const purpose = document.getElementById('inputPurpose').value;

        if(!amount || !payee || !date) return alert("Fill all fields");

        const data = { date, payee, purpose, amount, type, updatedAt: new Date().toISOString() };

        try {
            if(editingId) { await updateDoc(doc(db, "transactions", editingId), data); }
            else { data.createdAt = new Date().toISOString(); await addDoc(collection(db, "transactions"), data); }
            document.getElementById('mainModal').style.display = 'none';
        } catch (e) { alert("Error saving: " + e.message); }
    }

    window.deleteTransaction = async function() {
        if(!editingId) return;
        if(confirm("Delete this record?")) {
            await deleteDoc(doc(db, "transactions", editingId));
            document.getElementById('mainModal').style.display = 'none';
        }
    }
    
    // Init
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('inputDate').value = getLocalDate();
        checkAuth();
    });
</script>

</body>
</html>