<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Spending Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg-color: #0f172a; --card-bg: #1e293b; --input-bg: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --accent-green: #10b981; --accent-red: #ef4444; 
            --accent-blue: #3b82f6; --accent-orange: #f59e0b; --border-color: #334155;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .dashboard { width: 100%; max-width: 650px; }
        
        .summary-card { background-color: var(--card-bg); padding: 30px 25px; border-radius: 16px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); position: relative; }
        .filter-row { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .date-select { background: var(--bg-color); color: var(--text-muted); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        .custom-date-row { display: none; justify-content: flex-end; gap: 5px; margin-bottom: 15px; }
        .summary-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: 600; letter-spacing: 1px;}
        .summary-balance { font-size: 3.5rem; font-weight: 700; margin: 10px 0; letter-spacing: -1px; color: var(--text-main); }
        .flow-container { display: flex; justify-content: center; gap: 20px; margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .flow-item { flex: 1; }
        .flow-item div:first-child { font-size: 0.75rem; color: var(--text-muted); margin-bottom:5px; text-transform: uppercase;}
        .flow-item div:last-child { font-size: 1.1rem; font-weight: 600; }
        .text-green { color: var(--accent-green); } .text-red { color: var(--accent-red); } .text-orange { color: var(--accent-orange); }

        .section-header { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 35px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .section-header h3 { margin: 0; font-weight: 600; font-size: 1.1rem; color: var(--text-main); }
        .section-sub { font-size: 0.85rem; color: var(--text-muted); }
        .btn-mini { background: var(--input-bg); border: none; color: var(--text-main); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-left: 10px; }

        .tracker-grid { display: grid; gap: 12px; }
        .tracker-card { background-color: var(--card-bg); padding: 15px 20px; border-radius: 12px; display: flex; flex-direction: column; gap: 8px; cursor: pointer; transition: background 0.2s; }
        .tracker-card:active { background-color: #263345; }
        .tracker-top { display: flex; justify-content: space-between; font-size: 0.95rem; align-items: center; }
        .tracker-name { display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .lock-icon { font-size: 0.8rem; opacity: 0.5; }
        .tracker-bar-bg { height: 8px; background-color: var(--input-bg); border-radius: 4px; overflow: hidden; margin-top: 5px;}
        .tracker-bar-fill { height: 100%; background-color: var(--accent-blue); width: 0%; transition: width 0.6s ease; }
        
        .vault-details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .vault-actions { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-vault-action { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .btn-deposit { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .btn-withdraw { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .vault-history-list { list-style: none; padding: 0; margin: 0; font-size: 0.85rem; }
        .vault-history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #334155; color: var(--text-muted); }
        .vault-history-item:last-child { border-bottom: none; }

        .log-list { list-style: none; padding: 0; margin: 0; }
        .log-item { background-color: var(--card-bg); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
        .log-item:active { background-color: #263345; }
        .log-left { display: flex; flex-direction: column; gap: 4px; }
        .log-payee { font-weight: 500; font-size: 1rem; }
        .log-meta { font-size: 0.8rem; color: var(--text-muted); }
        .log-amount { font-weight: 600; font-size: 1rem; }
        
        .fab { position: fixed; bottom: 30px; right: 30px; background-color: var(--accent-blue); color: white; width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 32px; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); display: flex; align-items: center; justify-content: center; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 100; }
        .modal-card { background: var(--card-bg); width: 90%; max-width: 450px; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
        input, select { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color); color: white; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        .btn-primary { background: var(--text-main); color: var(--bg-color); width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-delete { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); border: 1px solid var(--accent-red); width: 100%; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; display: none; }
        .btn-text { background: none; border: none; color: var(--text-muted); cursor: pointer; width: 100%; margin-top: 15px; }
        .split-container { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-top: 10px; }
        .split-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .btn-small { background: #334155; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="summary-card">
        <div class="filter-row">
            <select id="dateFilter" class="date-select" onchange="handleDateFilterChange()">
                <option value="last7">Last 7 Days</option>
                <option value="mtd" selected>Month to Date</option>
                <option value="ytd">Year to Date</option>
                <option value="lastMonth">Last Month</option>
                <option value="custom">Custom Range...</option>
            </select>
        </div>
        <div id="customDateRange" class="custom-date-row">
            <input type="date" id="customStart" class="date-select" style="width:auto" onchange="render()">
            <input type="date" id="customEnd" class="date-select" style="width:auto" onchange="render()">
        </div>
        <div class="summary-label">Available Operating Cash</div>
        <div class="summary-balance" id="displayBalance">...</div>
        
        <div class="flow-container">
            <div class="flow-item">
                <div>Income (In)</div>
                <div class="text-green" id="displayIncome">...</div>
            </div>
            <div class="flow-item">
                <div>Expenses (Out)</div>
                <div class="text-red" id="displayExpense">...</div>
            </div>
            <div class="flow-item">
                <div>Vaults (Net)</div>
                <div id="displayVaultFlow">...</div>
            </div>
        </div>
    </div>

    <div class="section-header">
        <div>
            <h3>Vaults & Projects</h3>
            <span class="section-sub">Total Earmarked: <span id="displayVaultTotal" class="text-green">...</span></span>
        </div>
        <button class="btn-mini" onclick="openNewProjectModal()">+ Add</button>
    </div>
    <div style="font-size:0.8rem; color:#666; margin-bottom:10px; font-style:italic;">Tap a vault to view history or withdraw</div>
    <div class="tracker-grid" id="trackerList"></div>

    <div class="section-header">
        <h3>Transaction Log</h3>
    </div>
    <div style="font-size:0.8rem; color:#666; margin-bottom:10px; font-style:italic;">Tap a transaction to edit or delete</div>
    <ul class="log-list" id="transactionList"></ul>
</div>

<button class="fab" onclick="openMainModal()">+</button>

<div class="modal-overlay" id="mainModal">
    <div class="modal-card">
        <h2 style="margin-top:0; font-size:1.2rem;" id="modalTitle">New Transaction</h2>
        <div class="form-row">
            <div><label class="form-label">Type</label><select id="inputType"><option value="expense">Expense (Out)</option><option value="income">Income (In)</option></select></div>
            <div><label class="form-label">Date</label><input type="date" id="inputDate"></div>
        </div>
        <div class="form-group"><label class="form-label">Amount</label><input type="number" id="inputAmount" placeholder="0.00" step="0.01"></div>
        <div class="form-group"><label class="form-label">Payee</label><input type="text" id="inputPayee" placeholder="e.g. Costco"></div>
        <div class="form-group"><label class="form-label">For (Memo)</label><input type="text" id="inputPurpose" placeholder="e.g. Weekly Groceries"></div>

        <div class="form-group">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><label class="form-label">Category</label><label class="form-label" style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="toggleSplit" style="width:auto;" onchange="toggleSplitMode()"> Split?</label></div>
            <div id="singleCategoryMode" style="display:flex; gap:10px;">
                <select id="inputCategory" style="flex:1;"><option value="Uncategorized">Select...</option></select>
                <button class="btn-small" onclick="addNewCategory()">+ New</button>
            </div>
            <div id="splitCategoryMode" class="split-container" style="display:none;"><div id="splitRows"></div><button type="button" class="btn-small" onclick="addSplitRow()">+ Split</button></div>
        </div>
        
        <button id="btnSave" class="btn-primary" onclick="saveTransaction()">Save Record</button>
        <button id="btnDelete" class="btn-delete" onclick="deleteTransaction()">Delete Record</button>
        <button class="btn-text" onclick="closeMainModal()">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="transferModal">
    <div class="modal-card">
        <h2 style="margin-top:0; font-size:1.2rem;" id="transferTitle">Vault Transfer</h2>
        <div style="color: var(--text-muted); font-size:0.9rem; margin-bottom:15px;" id="transferTargetName"></div>
        <input type="hidden" id="transferProjectId">
        
        <div class="form-group"><label class="form-label">Date</label><input type="date" id="transferDate"></div>
        
        <div class="form-group"><label class="form-label">Action</label><select id="transferDir"><option value="in">ðŸ”’ Deposit to Vault (Reduces Operating Cash)</option><option value="out">ðŸ”“ Withdraw to Cash (Increases Operating Cash)</option></select></div>
        <div class="form-group"><label class="form-label">Amount</label><input type="number" id="transferAmount" placeholder="0.00"></div>
        
        <button id="btnTransferSave" class="btn-primary" onclick="executeTransfer()">Confirm Transfer</button>
        <button id="btnTransferDelete" class="btn-delete" onclick="deleteTransfer()">Delete Transfer</button>
        <button class="btn-text" onclick="document.getElementById('transferModal').style.display='none'">Cancel</button>
    </div>
</div>

<div class="modal-overlay" id="newProjectModal">
    <div class="modal-card">
        <h2 style="margin-top:0; font-size:1.2rem;">New Vault</h2>
        <div class="form-group"><label class="form-label">Vault Name</label><input type="text" id="newProjName" placeholder="e.g. New Car"></div>
        <div class="form-group"><label class="form-label">Goal Amount</label><input type="number" id="newProjGoal" placeholder="5000"></div>
        <button class="btn-primary" onclick="createNewProject()">Create Vault</button>
        <button class="btn-text" onclick="document.getElementById('newProjectModal').style.display='none'">Cancel</button>
    </div>
</div>

<script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBLFyr142xhL8OZroHAnsGGSWX7hPf1UG0",
        authDomain: "family-wealth-tracker-18699.firebaseapp.com",
        projectId: "family-wealth-tracker-18699",
        storageBucket: "family-wealth-tracker-18699.firebasestorage.app",
        messagingSenderId: "162214392302",
        appId: "1:162214392302:web:3e40142cbed3df59fbdeff"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let localState = { transactions: [], vaults: [], categories: [] };
    let editingId = null; // Tracks if we are editing
    const DEFAULT_CATS = ["Groceries", "Dining", "Housing", "Utilities", "Transport", "Entertainment", "Shopping", "Health"];

    // --- LISTENERS ---
    const q = query(collection(db, "transactions"), orderBy("date", "desc"));
    onSnapshot(q, (snapshot) => {
        localState.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
    });

    const qVaults = query(collection(db, "vaults"));
    onSnapshot(qVaults, (snapshot) => {
        localState.vaults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        render();
    });

    const qCats = query(collection(db, "categories"), orderBy("name"));
    onSnapshot(qCats, async (snapshot) => {
        if (snapshot.empty) {
            DEFAULT_CATS.forEach(async c => await addDoc(collection(db, "categories"), { name: c }));
        } else {
            localState.categories = snapshot.docs.map(doc => doc.data().name);
            updateCategoryDropdowns();
        }
    });

    // --- RENDER FUNCTION ---
    window.render = function() {
        const dateRange = getDateRange();
        
        let currentBalance = 0;
        localState.transactions.forEach(t => {
            if (t.type === 'income') currentBalance += t.amount;
            if (t.type === 'expense') currentBalance -= t.amount;
            if (t.type === 'transfer') {
                if(t.transferDir === 'in') currentBalance -= t.amount; 
                if(t.transferDir === 'out') currentBalance += t.amount; 
            }
        });
        document.getElementById('displayBalance').textContent = formatMoney(currentBalance);

        let filteredTrans = localState.transactions;
        if (dateRange) {
            filteredTrans = localState.transactions.filter(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                return tDate >= dateRange.start && tDate <= dateRange.end;
            });
        }

        let income = 0; let expense = 0; let netVault = 0;
        filteredTrans.forEach(t => {
            if (t.type === 'income') income += t.amount;
            if (t.type === 'expense') expense += t.amount;
            if (t.type === 'transfer') {
                if (t.transferDir === 'in') netVault += t.amount;
                else if (t.transferDir === 'out') netVault -= t.amount;
            }
        });

        document.getElementById('displayIncome').textContent = '+' + formatMoney(income);
        document.getElementById('displayExpense').textContent = '-' + formatMoney(expense);
        
        const vaultEl = document.getElementById('displayVaultFlow');
        if (netVault > 0) { vaultEl.textContent = '+' + formatMoney(netVault); }
        else if (netVault < 0) { vaultEl.textContent = formatMoney(netVault).replace('$-', '-$'); }
        else { vaultEl.textContent = '$0.00'; }
        vaultEl.className = ''; 

        // Vaults
        const trackerList = document.getElementById('trackerList');
        trackerList.innerHTML = '';
        let totalVaulted = 0;
        localState.vaults.forEach(v => {
            totalVaulted += v.current;
            const pct = Math.min(100, (v.current / v.goal) * 100);
            const vaultTrans = localState.transactions.filter(t => 
                t.type === 'transfer' && (t.vaultId === v.id || t.payee.includes(v.name))
            ).slice(0, 5);

            let historyHTML = '';
            vaultTrans.forEach(vt => {
                const isDeposit = vt.transferDir === 'in';
                const color = isDeposit ? 'text-green' : 'text-red';
                const sign = isDeposit ? '+' : '-';
                historyHTML += `<li class="vault-history-item"><span>${vt.date}</span><span class="${color}">${sign}${formatMoney(vt.amount)}</span></li>`;
            });

            trackerList.innerHTML += `
                <div class="tracker-card" onclick="toggleVaultDetails('${v.id}')">
                    <div class="tracker-top">
                        <div class="tracker-name"><span class="lock-icon">ðŸ”’</span><span>${v.name}</span></div>
                        <div><span style="color:var(--text-muted)">${formatMoney(v.current)} / ${formatMoney(v.goal)}</span></div>
                    </div>
                    <div class="tracker-bar-bg"><div class="tracker-bar-fill" style="width: ${pct}%"></div></div>
                    <div id="vault-details-${v.id}" class="vault-details" onclick="event.stopPropagation()">
                        <div class="vault-actions">
                            <button class="btn-vault-action btn-deposit" onclick="openTransferModal('${v.id}', '${v.name}', 'in')">Deposit (+)</button>
                            <button class="btn-vault-action btn-withdraw" onclick="openTransferModal('${v.id}', '${v.name}', 'out')">Withdraw (-)</button>
                        </div>
                        <ul class="vault-history-list">${historyHTML.length > 0 ? historyHTML : '<li class="vault-history-item">No history yet</li>'}</ul>
                    </div>
                </div>`;
        });
        document.getElementById('displayVaultTotal').innerText = formatMoney(totalVaulted);

        // Logs
        const logList = document.getElementById('transactionList');
        logList.innerHTML = '';
        if(filteredTrans.length === 0) logList.innerHTML = '<li style="text-align:center; padding:20px; color:#555;">No transactions</li>';
        
        filteredTrans.forEach(t => {
            let colorClass = 'text-main'; let sign = '';
            if(t.type === 'income') { colorClass = 'text-green'; sign = '+'; }
            if(t.type === 'expense') { colorClass = 'text-red'; sign = '-'; }
            if(t.type === 'transfer') { colorClass = 'text-orange'; sign = ''; } 
            
            let catString = t.categories ? t.categories.map(c => c.name).join(', ') : '';
            let metaString = catString;
            if (t.purpose && t.purpose.trim() !== "") {
                metaString = `${t.purpose} <span style="opacity:0.6">(${catString})</span>`; 
            } else {
                metaString = `<span style="opacity:0.6">${catString}</span>`;
            }
            
            logList.innerHTML += `
                <li class="log-item" onclick="routeEdit('${t.id}')">
                    <div class="log-left">
                        <div class="log-payee">${t.payee}</div>
                        <div class="log-meta"><span>${t.date}</span> &bull; ${metaString}</div>
                    </div>
                    <div class="log-amount ${colorClass}">${sign}${formatMoney(t.amount)}</div>
                </li>`;
        });
    }

    // --- UTILS ---
    window.getLocalDate = function() {
        const d = new Date();
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0,10);
    }

    window.updateCategoryDropdowns = function() {
        const selects = document.querySelectorAll('select[id="inputCategory"], .split-cat-select');
        selects.forEach(sel => {
            const currentVal = sel.value; 
            sel.innerHTML = '<option value="Uncategorized">Select...</option>';
            localState.categories.forEach(cat => { sel.innerHTML += `<option value="${cat}">${cat}</option>`; });
            if (currentVal && currentVal !== 'Uncategorized') sel.value = currentVal;
        });
    }

    window.addNewCategory = async function() {
        const name = prompt("Enter new category name:");
        if (name && name.trim() !== "") {
            await addDoc(collection(db, "categories"), { name: name.trim() });
        }
    }

    window.toggleVaultDetails = function(id) {
        const el = document.getElementById(`vault-details-${id}`);
        document.querySelectorAll('.vault-details').forEach(d => { if(d.id !== `vault-details-${id}`) d.style.display = 'none'; });
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    // --- EDIT ROUTING ---
    window.routeEdit = function(id) {
        const t = localState.transactions.find(x => x.id === id);
        if(!t) return;
        if(t.type === 'transfer') {
            editTransfer(t);
        } else {
            editTransaction(t);
        }
    }

    // --- STANDARD TRANSACTION EDITING ---
    window.openMainModal = function() {
        editingId = null;
        document.getElementById('modalTitle').innerText = "New Transaction";
        document.getElementById('btnSave').innerText = "Save Record";
        document.getElementById('btnDelete').style.display = 'none';
        
        document.getElementById('inputType').value = 'expense';
        document.getElementById('inputDate').value = getLocalDate(); // FIXED DATE
        document.getElementById('inputAmount').value = '';
        document.getElementById('inputPayee').value = '';
        document.getElementById('inputPurpose').value = '';
        document.getElementById('inputCategory').value = 'Uncategorized';
        document.getElementById('toggleSplit').checked = false;
        window.toggleSplitMode();
        
        document.getElementById('mainModal').style.display = 'flex';
    }

    window.editTransaction = function(t) {
        editingId = t.id;
        document.getElementById('modalTitle').innerText = "Edit Transaction";
        document.getElementById('btnSave').innerText = "Update Transaction";
        document.getElementById('btnDelete').style.display = 'block';

        document.getElementById('inputType').value = t.type;
        document.getElementById('inputDate').value = t.date;
        document.getElementById('inputAmount').value = t.amount;
        document.getElementById('inputPayee').value = t.payee;
        document.getElementById('inputPurpose').value = t.purpose || '';
        
        if(t.categories && t.categories.length > 1) {
            document.getElementById('toggleSplit').checked = true;
            window.toggleSplitMode();
            document.getElementById('splitRows').innerHTML = ''; 
            t.categories.forEach(c => {
               let options = '<option value="Uncategorized">Select...</option>';
               localState.categories.forEach(cat => options += `<option value="${cat}">${cat}</option>`);
               document.getElementById('splitRows').innerHTML += `
                <div class="split-row">
                    <select class="split-cat-select" style="flex:2;">${options}</select>
                    <input type="number" class="split-cat-pct" placeholder="%" style="flex:1;" value="${c.pct}">
                    <button type="button" class="btn-small" onclick="this.parentElement.remove()">x</button>
                </div>`;
                const rows = document.querySelectorAll('.split-row');
                rows[rows.length-1].querySelector('select').value = c.name;
            });
        } else {
            document.getElementById('toggleSplit').checked = false;
            window.toggleSplitMode();
            if(t.categories && t.categories.length > 0) {
                document.getElementById('inputCategory').value = t.categories[0].name;
            }
        }
        document.getElementById('mainModal').style.display = 'flex';
    }

    window.saveTransaction = async function() {
        const type = document.getElementById('inputType').value;
        const date = document.getElementById('inputDate').value;
        const amount = parseFloat(document.getElementById('inputAmount').value);
        const payee = document.getElementById('inputPayee').value;
        const purpose = document.getElementById('inputPurpose').value;
        const isSplit = document.getElementById('toggleSplit').checked;

        if(!amount || !payee || !date) return alert("Fill all fields");

        let categories = [];
        if (!isSplit) {
            categories.push({ name: document.getElementById('inputCategory').value, pct: 100 });
        } else {
            const rows = document.querySelectorAll('.split-row');
            let totalPct = 0;
            rows.forEach(row => {
                const name = row.querySelector('.split-cat-select').value;
                const pct = parseFloat(row.querySelector('.split-cat-pct').value) || 0;
                totalPct += pct;
                categories.push({ name, pct });
            });
            if(Math.abs(totalPct - 100) > 0.1) return alert(`Split percentages sum to ${totalPct}%. They must total 100%.`);
        }

        const data = {
            date, payee, purpose, amount, type, categories,
            updatedAt: new Date().toISOString()
        };

        try {
            if(editingId) {
                await updateDoc(doc(db, "transactions", editingId), data);
            } else {
                data.createdAt = new Date().toISOString();
                await addDoc(collection(db, "transactions"), data);
            }
            document.getElementById('mainModal').style.display = 'none';
        } catch (e) { alert("Error saving: " + e.message); }
    }

    window.deleteTransaction = async function() {
        if(!editingId) return;
        if(confirm("Delete this record?")) {
            await deleteDoc(doc(db, "transactions", editingId));
            document.getElementById('mainModal').style.display = 'none';
        }
    }

    // --- VAULT TRANSFER EDITING ---
    window.openTransferModal = function(id, name, dir) {
        editingId = null;
        document.getElementById('transferTitle').innerText = "Vault Transfer";
        document.getElementById('btnTransferSave').innerText = "Confirm Transfer";
        document.getElementById('btnTransferDelete').style.display = 'none';
        
        document.getElementById('transferProjectId').value = id;
        document.getElementById('transferTargetName').innerText = `Transferring for: ${name}`;
        if(dir) document.getElementById('transferDir').value = dir;
        document.getElementById('transferDate').value = getLocalDate(); // FIXED DATE
        document.getElementById('transferAmount').value = '';
        
        document.getElementById('transferModal').style.display = 'flex';
    }

    window.editTransfer = function(t) {
        editingId = t.id;
        document.getElementById('transferTitle').innerText = "Edit Transfer";
        document.getElementById('btnTransferSave').innerText = "Update Transfer";
        document.getElementById('btnTransferDelete').style.display = 'block';

        document.getElementById('transferProjectId').value = t.vaultId;
        // Find vault name
        const v = localState.vaults.find(x => x.id === t.vaultId);
        document.getElementById('transferTargetName').innerText = v ? `Transferring for: ${v.name}` : 'Unknown Vault';
        
        document.getElementById('transferDir').value = t.transferDir;
        document.getElementById('transferDate').value = t.date;
        document.getElementById('transferAmount').value = t.amount;
        
        document.getElementById('transferModal').style.display = 'flex';
    }

    window.executeTransfer = async function() {
        const id = document.getElementById('transferProjectId').value;
        const amount = parseFloat(document.getElementById('transferAmount').value);
        const dir = document.getElementById('transferDir').value;
        const date = document.getElementById('transferDate').value;
        if(!amount) return;

        const project = localState.vaults.find(v => v.id === id);
        if(!project) return;
        
        try {
            // IF EDITING: Revert old math first
            let currentVaultBalance = project.current;
            if(editingId) {
                const oldT = localState.transactions.find(x => x.id === editingId);
                if(oldT) {
                    // Reverse old: if in, subtract. if out, add.
                    if(oldT.transferDir === 'in') currentVaultBalance -= oldT.amount;
                    else currentVaultBalance += oldT.amount;
                }
            }

            // Apply NEW math
            if(dir === 'in') currentVaultBalance += amount;
            else currentVaultBalance -= amount;

            // Save Vault
            await updateDoc(doc(db, "vaults", id), { current: currentVaultBalance });
            
            // Save Transaction
            const data = {
                date: date,
                payee: (dir === 'in' ? "To Vault: " : "From Vault: ") + project.name,
                amount: amount,
                type: 'transfer',
                transferDir: dir,
                vaultId: id, 
                categories: [{name: 'Transfer', pct: 100}]
            };

            if(editingId) {
                await updateDoc(doc(db, "transactions", editingId), data);
            } else {
                data.createdAt = new Date().toISOString();
                await addDoc(collection(db, "transactions"), data);
            }
            
            document.getElementById('transferModal').style.display = 'none';
        } catch(e) { alert("Transfer failed: " + e.message); }
    }

    window.deleteTransfer = async function() {
        if(!editingId) return;
        if(!confirm("Delete this transfer and revert balance?")) return;

        const t = localState.transactions.find(x => x.id === editingId);
        const v = localState.vaults.find(x => x.id === t.vaultId);
        
        if(t && v) {
            let newBalance = v.current;
            // Reverse math
            if(t.transferDir === 'in') newBalance -= t.amount;
            else newBalance += t.amount;
            
            await updateDoc(doc(db, "vaults", v.id), { current: newBalance });
        }
        
        await deleteDoc(doc(db, "transactions", editingId));
        document.getElementById('transferModal').style.display = 'none';
    }

    window.createNewProject = async function() {
        const name = document.getElementById('newProjName').value;
        const goal = parseFloat(document.getElementById('newProjGoal').value);
        if(!name || !goal) return;
        try {
            await addDoc(collection(db, "vaults"), { name, current: 0, goal });
            document.getElementById('newProjectModal').style.display = 'none';
        } catch(e) { console.error(e); }
    }

    // --- HELPERS ---
    window.handleDateFilterChange = function() {
        const val = document.getElementById('dateFilter').value;
        const customDiv = document.getElementById('customDateRange');
        if (val === 'custom') customDiv.style.display = 'flex';
        else { customDiv.style.display = 'none'; render(); }
    }
    window.getDateRange = function() {
        const filter = document.getElementById('dateFilter').value;
        const now = new Date();
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
        let start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);

        if (filter === 'last7') start.setDate(now.getDate() - 6);
        else if (filter === 'mtd') start.setDate(1);
        else if (filter === 'ytd') start.setMonth(0, 1);
        else if (filter === 'lastMonth') {
            return { start: new Date(now.getFullYear(), now.getMonth() - 1, 1), end: new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59) };
        } else if (filter === 'custom') {
            const sVal = document.getElementById('customStart').value;
            const eVal = document.getElementById('customEnd').value;
            if (!sVal || !eVal) return null;
            return { start: new Date(sVal + 'T00:00:00'), end: new Date(eVal + 'T23:59:59') };
        }
        return { start, end };
    }
    window.formatMoney = function(num) { return '$' + num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
    window.closeMainModal = function() { document.getElementById('mainModal').style.display = 'none'; }
    window.toggleSplitMode = function() {
        const isSplit = document.getElementById('toggleSplit').checked;
        document.getElementById('singleCategoryMode').style.display = isSplit ? 'none' : 'flex';
        document.getElementById('splitCategoryMode').style.display = isSplit ? 'block' : 'none';
    }
    window.addSplitRow = function() {
        let options = '<option value="Uncategorized">Select...</option>';
        localState.categories.forEach(cat => options += `<option value="${cat}">${cat}</option>`);
        document.getElementById('splitRows').innerHTML += `
            <div class="split-row">
                <select class="split-cat-select" style="flex:2;">${options}</select>
                <input type="number" class="split-cat-pct" placeholder="%" style="flex:1;">
                <button type="button" class="btn-small" onclick="this.parentElement.remove()">x</button>
            </div>`;
    }
    window.openNewProjectModal = function() { document.getElementById('newProjectModal').style.display = 'flex'; }
    
    // Init
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('inputDate').value = getLocalDate();
        window.toggleSplitMode();
    });
</script>

</body>
</html>